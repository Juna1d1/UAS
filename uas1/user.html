<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>User - Inventaris</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #eef2f3; }
    input { margin: 5px; padding: 5px; width: 200px; }
    button { padding: 5px 10px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #343a40; color: white; }
  </style>
</head>
<body>
  <h2>Pinjam Inventaris</h2>

  <input id="namaAlat" placeholder="Nama Alat" />
  <input id="jumlahPinjam" type="number" placeholder="Jumlah" />
  <button onclick="ajukanPinjam()">Ajukan Peminjaman</button>

  <h3>Riwayat Peminjaman</h3>
  <table>
    <thead>
      <tr><th>Alat</th><th>Jumlah</th><th>Status</th><th>Denda</th><th>Aksi</th></tr>
    </thead>
    <tbody id="logBody"></tbody>
  </table>

  <script>
    const supabase = supabase.createClient('https://pmgnuwototighfbmegdt.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtZ251d290b3RpZ2hmYm1lZ2R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1ODkwNTQsImV4cCI6MjA2MjE2NTA1NH0.QjQiA6V8HnV5LWviQGCbPuQ_PuxNAVqcbL6U_epUOEg');
    const peminjam = localStorage.getItem("peminjam");

    async function ajukanPinjam() {
      const alat = document.getElementById("namaAlat").value;
      const jumlah = parseInt(document.getElementById("jumlahPinjam").value);

      await supabase.from('peminjaman').insert({
        nama_alat: alat,
        jumlah,
        peminjam,
        status: 'menunggu',
        kondisi_kembali: '-',
        denda: 0
      });
      loadLog();
    }

    async function loadLog() {
      const { data } = await supabase
        .from('peminjaman')
        .select('*')
        .eq('peminjam', peminjam);
      
      const tbody = document.getElementById('logBody');
      tbody.innerHTML = data.map(item => `
        <tr>
          <td>${item.nama_alat}</td>
          <td>${item.jumlah}</td>
          <td>${item.status}</td>
          <td>${item.denda || 0}</td>
          <td>
            ${item.status === 'dipinjam' ? `
              <button onclick="kembalikan('${item.id}')">Kembalikan</button>
            ` : '-'}
          </td>
        </tr>
      `).join('');
    }

    async function kembalikan(id) {
      const kondisi = prompt("Masukkan kondisi alat (baik / rusak):").toLowerCase();
      let denda = 0;
      if (kondisi === "rusak") {
        denda = 50000;
        alert("Barang rusak. Anda dikenakan denda Rp" + denda);
      }

      await supabase
        .from("peminjaman")
        .update({ status: "dikembalikan", kondisi_kembali: kondisi, denda })
        .eq("id", id);

      loadLog();
    }

    loadLog();
  </script>
</body>
</html>
